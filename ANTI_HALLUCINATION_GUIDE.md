# Anti-Hallucination System Guide

This document explains the verification system that prevents AI hallucinations from corrupting the database.

## Database Schema Updates

### New Columns Added to `artworks` table:

1. **`is_verified`** (Boolean, default `false`)
   - `true`: Verified by museum or admin
   - `false`: AI-generated or community-sourced (unverified)

2. **`source`** (String)
   - `'museum_api'`: From official museum API
   - `'ai_generated'`: Generated by GPT-4o-mini
   - `'admin'`: Manually added by admin
   - `'community'`: User-submitted

3. **`confidence_score`** (Float, nullable)
   - Range: 0.0 - 1.0
   - `0.8`: High confidence (from GPT-4o-mini)
   - `0.5`: Medium confidence
   - `0.3`: Low confidence

### Migration

Run the migration in Supabase SQL Editor:
```sql
-- See: database/migration_add_verification.sql
```

## Backend Logic Flow

### Step 1: Vector Search

1. Generate CLIP embedding for uploaded image
2. Search artworks table (cosine distance < 0.15)

**If Match Found:**
- Check `is_verified` flag
- **If `is_verified = true`**: Return as **"Verified Result"** (Green badge)
- **If `is_verified = false`**: Return as **"Community/AI Result"** (Orange badge with warning)

### Step 2: No Match (Auto-Cataloging)

1. Call GPT-4o-mini with enhanced prompt:
   - Asks for confidence score (low/medium/high)
   - Explicitly labels uncertain titles as "Unknown Art"
   - Returns structured JSON

2. **CRITICAL Save Rules:**
   - `is_verified = false` (always)
   - `source = 'ai_generated'` (always)
   - `confidence_score` = converted from text (high=0.8, medium=0.5, low=0.3)

3. Insert into database with embedding

4. Return with `badge: "AI Estimate"` flag

## Frontend Display

### Badge System

- **Green Badge "ðŸ›ï¸ Official Museum Data"**: 
  - Shown when `is_verified = true`
  - Trusted, verified data

- **Orange Badge "âœ¨ AI Analysis"** or **"âœ¨ AI Estimate"**:
  - Shown when `is_verified = false`
  - Unverified AI-generated data
  - Includes "Report Issue" button

### Report Issue Feature

Users can report:
- Wrong Title
- Wrong Artist  
- Not an Artwork

Reports are logged (TODO: Create reports table in production)

## API Response Format

### Verified Result
```json
{
  "status": "verified_result",
  "artwork": {
    "id": 1,
    "title": "The Starry Night",
    "artist": "Vincent van Gogh",
    "is_verified": true,
    "source": "museum_api"
  },
  "badge": "Official Museum Data",
  "ai_generated": false
}
```

### AI-Generated Result
```json
{
  "status": "ai_analysis",
  "artwork": {
    "id": 2,
    "title": "Unknown Art",
    "artist": "Unknown",
    "is_verified": false,
    "source": "ai_generated",
    "confidence_score": 0.3,
    "confidence": "low"
  },
  "badge": "AI Estimate",
  "ai_generated": true,
  "cataloged": true
}
```

## Best Practices

1. **Always set `is_verified=false` for AI-generated entries**
2. **Always set `source='ai_generated'` for GPT-4o-mini results**
3. **Include confidence scores** to help users understand reliability
4. **Show clear badges** so users know data quality
5. **Enable reporting** to catch and fix hallucinations

## Future Enhancements

- Create `reports` table to track user feedback
- Admin dashboard to review and verify AI-generated entries
- Automatic verification when multiple users confirm same artwork
- Confidence threshold to prevent low-confidence entries
